<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="西湖小龙人">
<meta property="og:url" content="http://xihuxiaolongren.com/index.html">
<meta property="og:site_name" content="西湖小龙人">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="西湖小龙人">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://xihuxiaolongren.com/"/>

  <title> 西湖小龙人 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">西湖小龙人</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/10/Android实战-使用gradle打多渠道包/" itemprop="url">
                  Android实战-使用gradle打多渠道包
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-10-10T17:00:47+08:00" content="2015-10-10">
              2015-10-10
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>加入新公司后，将项目从Eclipse转到了Android Studio，转换后第一个需要解决的就是编写新的打包脚本。</p>
<p>Studio默认使用gradle打包，对于gradle还不熟悉的同学，可以先去看看这两篇文章</p>
<p><a href="http://segmentfault.com/a/1190000002910311" target="_blank" rel="external">Gradle构建Android项目</a></p>
<p><a href="http://blog.isming.me/2014/11/21/use-gradle-new/" target="_blank" rel="external">使用gradle构建android项目（续）</a></p>
<p>我们当时主要面临三个问题：</p>
<p>1、不同环境：开发，测试，正式三套环境，api地址，第三方推送配置等都不相同；</p>
<p>2、Android有着众多的市场，在打正式包时，我们需要区分不同的渠道，便于统计下载量及分析不同渠道的相关数据情况，需要发布多个渠道包；</p>
<p>3、打出的文件名等需要定制化并区分渠道和环境等；</p>
<p>上述问题在gradle中都可以在build.gradle脚本文件中的配置。<br>首先解决第一个问题，在buildTypes中分别定义三套不同环境的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">buildTypes &#123;</div><div class="line">    debug &#123;</div><div class="line">        manifestPlaceholders = [AppID : &quot;XXX&quot;, AppSecret : &quot;XXX&quot;, AppKey : &quot;XXX&quot;,UMEN_AppKey : &quot;XXX&quot;]</div><div class="line">        buildConfigField &quot;String&quot;, &quot;SERVER_PATH&quot;, &quot;\&quot;http://debug.com\&quot;&quot;</div><div class="line">        buildConfigField &quot;boolean&quot;, &quot;LOG_DEBUG&quot;, &quot;false&quot;</div><div class="line">        buildConfigField &quot;String&quot;, &quot;CHANNEL&quot;, &quot;\&quot;000\&quot;&quot;//渠道号</div><div class="line">        versionNameSuffix &quot;-de&quot;</div><div class="line">    &#125;</div><div class="line">    qatest &#123;</div><div class="line">         manifestPlaceholders = [AppID : &quot;XXX&quot;, AppSecret : &quot;XXX&quot;, AppKey : &quot;XXX&quot;,UMEN_AppKey : &quot;XXX&quot;]</div><div class="line">         buildConfigField &quot;String&quot;, &quot;SERVER_PATH&quot;, &quot;\&quot;http://qatest.com\&quot;&quot;</div><div class="line">         buildConfigField &quot;boolean&quot;, &quot;LOG_DEBUG&quot;, &quot;false&quot;</div><div class="line">         buildConfigField &quot;String&quot;, &quot;CHANNEL&quot;, &quot;\&quot;000\&quot;&quot;//渠道号</div><div class="line">         versionNameSuffix “-qa&quot;</div><div class="line">    &#125;</div><div class="line">    release&#123;</div><div class="line"></div><div class="line">          manifestPlaceholders = [AppID : &quot;XXX&quot;, AppSecret : &quot;XXX&quot;, AppKey : &quot;XXX&quot;,UMEN_AppKey : &quot;XXX”]Ï</div><div class="line">         buildConfigField &quot;String&quot;, &quot;SERVER_PATH&quot;, “\”http://release.com\&quot;&quot;</div><div class="line">         buildConfigField &quot;boolean&quot;, &quot;LOG_DEBUG&quot;, &quot;false&quot;</div><div class="line">         buildConfigField &quot;String&quot;, &quot;CHANNEL&quot;, &quot;\&quot;000\&quot;&quot;//渠道号</div><div class="line">         versionNameSuffix “-qa&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中：<br>manifestPlaceholders用来替换在AndroidManifest文件中定义好的变量值，上例中前三个变量是个推的配置，最后一个是友盟统计；在文件中使用${UMEN_AppKey},则打包时会自动替换对应的值”XXX”。<br>buildConfigField用来创建一个全局静态常量，在程序中可以用BuildConfig.CHANNEL来使用该常量；<br>versionNameSuffix 表示是否给版本名称添加后缀，方便在测试时区分对应的是哪个环境版本的包。<br>在命令行运行：<br>./gradlew assembleDebug<br>./gradlew assembleQatest<br>./gradlew assembleRelease<br>即会生成不同的变量值。<br>上一步已经解决了如何区分不同环境包对应的一些配置信息，接下来解决多渠道打包问题。我们的应用中自定义了一套统计方式，而区分各个渠道只需要在程序中为不同渠道生成一个唯一的渠道号即可；可以如下添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">productFlavors &#123;</div><div class="line">    company &#123;</div><div class="line">        buildConfigField &quot;String&quot;, &quot;CHANNEL&quot;, &quot;\&quot;000\&quot;&quot;    //  官方包</div><div class="line">    &#125;</div><div class="line">    tencent &#123;</div><div class="line">        buildConfigField &quot;String&quot;, &quot;CHANNEL&quot;, &quot;\&quot;001\&quot;&quot;    //  应用宝</div><div class="line">    &#125;</div><div class="line">    baidu &#123;</div><div class="line">        buildConfigField &quot;String&quot;, &quot;CHANNEL&quot;, &quot;\&quot;002\&quot;&quot;    //  百度手机助手</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样在执行上述命令./gradlew assembleDebug时，就会生成三个或更多地渠道包（开发环境），而每个包都将有一个唯一的渠道号（CHANNEL）。<br>注意运行上述命令将会打出所有的渠道，如果想单独打一个渠道包，则运行下述命令即可:<br>./gradlew assembleCompanyDebug</p>
<p>最后，我们虽然生成了多个渠道包，但是包名的规则还未确定。比如你想要生成的包名如下格式：</p>
<p>应用名<em>渠道名</em>版本号.apk</p>
<p>wahaha_baidu_v1.0.apk</p>
<p>可以使用如下方式：</p>
<p>在buildTypes中添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">applicationVariants.all &#123; variant -&gt;</div><div class="line">    variant.outputs.each &#123; output -&gt;</div><div class="line">        def outputFile = output.outputFile</div><div class="line">        // 输出apk名称为wahaha_001_wandoujia_v1.0.apk</div><div class="line">        if (variant.buildType.name.equals(&quot;debug&quot;)) &#123;</div><div class="line">            def fileName = &quot;wahaha_debug_v$&#123;defaultConfig.versionName&#125;.apk&quot;</div><div class="line">            output.outputFile = new File(outputFile.parent, fileName)</div><div class="line">        &#125;else if(variant.buildType.name.equals(&quot;qatest&quot;))&#123;</div><div class="line">            def fileName = &quot;wahaha_qatest_v$&#123;defaultConfig.versionName&#125;.apk&quot;</div><div class="line">            output.outputFile = new File(outputFile.parent, fileName)</div><div class="line">        &#125;else if(variant.buildType.name.equals(&quot;release&quot;))&#123;</div><div class="line">            def fileName = &quot;wahaha$&#123;variant.productFlavors[0].name&#125;_v$&#123;defaultConfig.versionName&#125;.apk&quot;</div><div class="line">            output.outputFile = new File(outputFile.parent, fileName)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>gradle对于多渠道和不同环境打包的支持非常优雅，也是Google官方推荐的打包方式，除了上面这些功能，还有很多支持的功能如：代码混淆，zip对齐，dex超过65535限制等等，在前面两篇文章中都有讲解，大家有什么问题也可以在评论中一起探讨。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/10/Android实战-初探EventBus/" itemprop="url">
                  Android实战-初探EventBus
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-10-10T11:57:35+08:00" content="2015-10-10">
              2015-10-10
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近项目中需要实现一个功能，当用户要发布一条消息时，在当前activity堆栈中可能存在多个页面需要感知到这一事件，并将这条消息显示在最顶端。一开始想到用广播去实现，但是广播会让所有的应用都接收到广播，虽然可以过滤掉；后来寻找解决方案的过程中发现了EventBus，它提供的解决方案非常优雅，这里记录一下。（LocalBroadcastManager也可以实现，但是代码比起EventBus来说复杂一些）</p>
<p>实现上述功能所需代码示例如下：<br>1、定义一个事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class PublishDynamicEvent&#123;</div><div class="line">    private Dynamic dynamic;</div><div class="line">    private Dynamic sendingDynamic;</div><div class="line">    public PublishDynamicEvent(Dynamic dynamic, Dynamic sendingDynamic) &#123;</div><div class="line">        this.dynamic = dynamic;</div><div class="line">        this.sendingDynamic = sendingDynamic;</div><div class="line">    &#125;</div><div class="line">    public Dynamic getDynamic()&#123;</div><div class="line">        return dynamic;</div><div class="line">    &#125;</div><div class="line">    public Dynamic getSendingDynamic() &#123;</div><div class="line">        return sendingDynamic;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2、在需要感知该事件发生的activity中添加下述方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public void onEventMainThread(PublishDynamicEvent event) &#123;</div><div class="line">    …//处理该事件</div><div class="line">&#125;</div><div class="line">在onCreate方法中注册：</div><div class="line">@Override</div><div class="line">public void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">    ...</div><div class="line">    EventBus.getDefault().register(this);</div><div class="line">&#125;</div><div class="line">在onDestroy方法中取消注册：</div><div class="line">@Override</div><div class="line">protected void onDestroy()&#123;</div><div class="line">    super.onDestroy();</div><div class="line">    EventBus.getDefault().unregister(this);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3、在发布该事件的地方添加下面一句话：<br>EventBus.getDefault().post(new PrePublishDynamicEvent(dynamic));</p>
<p>是不是非常简单，可读性和灵活性都很高。EventBus应用的场景非常广泛，传统的事件传递方式包括：Handler、BroadCastReceiver、Interface 回调等都可以用用它来替代，再举个常见的例子：你的某些页面需要在接收到某些推送通知时，在布局上发生相应变化，诸如显示小红点，新消息数之类的提醒，都可以使用EventBus。</p>
<p>参考：</p>
<p><a href="http://www.codekk.com/blogs/detail/54cfab086c4761e5001b2538" target="_blank" rel="external">EventBus 源码解析</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/29/从零开始打造一个新闻订阅APP之服务器篇（二、类时间片轮转算法-redis-sorted-set-实现“逛”功能）/" itemprop="url">
                  从零开始打造一个新闻订阅APP之服务器篇（二、类时间片轮转算法+redis sorted set 实现“逛”功能）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-05-29T19:49:21+08:00" content="2015-05-29">
              2015-05-29
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>布板的“逛”页面效果如下：<br><img src="http://img.blog.csdn.net/20150529194512877" alt="这里写图片描述"><br>这个功能根据你的业务场景，可以很复杂，也可以很简单。<br>如果你的应用产生的内容非常多，而你想要根据多个维度来决定呈现给用户时，可能会依据：最新的，得分高的，或者是用户感兴趣的，等等。你可能需要的是一个搜索引擎，不过是系统自动帮你搜索，也可以称之为一个推荐引擎。<br>如果你只是需要实现一个实时排名系统，按照最新的展现出来，那么，只需要写几个sql语句就可以实现，当然，对于这种热点数据，用缓存等机制优化一下也是必要的；<br>在应用上线初期，APP中的内容较少，暂时无需很复杂的算法来进行筛选。当前，“逛”需要的仅仅是将各个“源”产生的内容以一种均匀、公平的方式推送给用户即可。<br>具体到实现上，先把需求量化出来：<br>暂定“逛”上限只有1000条内容集合（用户不会刷那么多的数据），如果当前集合已经达到1000条上限，则当一个新的内容需要加入时，需要从集合中删除最早的一条内容。<br>同时，在用户进入这个页面的时候，会产生三种请求：<br>进入页面，获取最新M条<br>下拉刷新/客户端定时更新，大于客户端最新一条数据更新时间的M条<br>上拉加载更多，小于客户端当前最后一条数据更新时间的M条</p>
<p>实现方式：<br>假定一分钟内有将近100个“源”更新了1000条信息，如何保证将每个“源”的信息以一种公平，均匀的方式插入到“逛”的集合中？<br>可以参考操作系统对于进程调度的时间片轮转算法。<br>以下来自百度百科：<br>时间片轮转调度是一种最古老，最简单，最公平且使用最广的算法。每个进程被分配一个时间段，称作它的时间片，即该进程允许运行的时间。如果在时间片结束时进程还在运行，则CPU将被剥夺并分配给另一个进程。如果进程在时间片结束前阻塞或结束，则CPU当即进行切换。调度程序所要做的就是维护一张就绪进程列表，当进程用完它的时间片后，它被移到队列的末尾。</p>
<p>对这个算法做一点改造，就可以实现上述所需的情况。每个“源”可以看做一个进程，并拥有属于自己的一个小的集合（最多只存5条信息）；当一个“源”更新了一条信息后，如果该“源”当前不存在，则生成一个新的“进程”，并加入到队列末尾；否则，直接加入该源的集合中；</p>
<p>同时维护一个类似于消费者的进程，每隔指定时间，从队列中取出一个“源”，并拿到其集合中最早一条信息，插入到“逛”集合中。<br>同时判断，如果该“源”的集合已经为空，则销毁该源，否则，将该源重新插入队尾;整个过程大致如下：<br><img src="http://img.blog.csdn.net/20150529194630550" alt="这里写图片描述"><br>经过上面的处理，基本实现了数据源的更新信息能够均匀，公平地插入到“逛”集合中；<br>那么，“逛”集合本身用何种方式实现呢？当前场景中，“逛”集合更新和查询的频率都很高，如果用数据库存储，有点麻烦，需要做较多的优化来支持插入和查询的优化；如果直接用程序管理一个内存集合，稳定性和独立性又比较低；综合考虑，决定用redis来实现“逛”集合，简单高效；<br>redis中有个zset数据结构，它的底层实现是skip list， 既支持排序，又支持快速的插入，删除，它和平衡树同样的效率，但实现要简单很多。<br><img src="http://img.blog.csdn.net/20150529194936767" alt="这里写图片描述"><br>这里主要有三个操作：<br>这里时间戳time作为score<br>插入一条数据：ZADD prefix time member时间复杂度O(log(N))<br>删除最早一条数据：ZREMRANGEBYRANK prefix 0 0时间复杂度O(log(N))<br>查找数据:时间复杂度（O(log(N) + M)）<br>最新M条（客户端首次加载（onCreate））：zrevrangeByScoreWithScores prefix MAX_VALUE MIN_VALUE 0 M<br>大于客户端更新时间的M条（下拉刷新/客户端定时更新）：zrangeByScoreWithScores  prefix updateTime MAX_VALUE 1 M<br>小于客户端更新时间的M条（上拉加载更多）：zrevrangeByScoreWithScores prefix updateTime MIN_VALUE 1 M</p>
<p>参考：<br><a href="https://redis.readthedocs.org/en/2.4/sorted_set.html" target="_blank" rel="external">https://redis.readthedocs.org/en/2.4/sorted_set.html</a><br><a href="http://csrd.aliapp.com/?tag=redis" target="_blank" rel="external">http://csrd.aliapp.com/?tag=redis</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/26/从零开始打造一个新闻订阅APP之Android篇（四、实现仿微信发图界面）/" itemprop="url">
                  从零开始打造一个新闻订阅APP之Android篇（四、实现仿微信发图界面）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-05-26T21:08:04+08:00" content="2015-05-26">
              2015-05-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在手机上发图大致分为<strong>拍照</strong>和<strong>选择手机图片</strong>两种类型：<br>拍照的步骤：如果不是专门的相机应用，直接调用系统相机，拍一张照片并返回即可；<br>选择手机图片的话，网上可以搜到很多相关文章，最常见的一种方式是，先遍历数据库，获取手机上全部缩略图，然后根据缩略图查找对应的原图路径；但我在小米4和htc M8两部手机上尝试了多种遍历所有缩略图的方式，发现并不是所有的原图都会有缩略图，这可能和应用程序或者android系统生成缩略图方式有关。<br>因此，只能换一种思路实现。一开始选择用缩略图做列表展示主要考虑的是大量展示原图可能存在内存开销较大和加载速度较慢，不过仔细思考后觉得既然这里的场景都是直接用从手机存储中读取图片，预估即使所有的图片不用缓存，全部直接从磁盘读取的速度应该都是可接受的，最终实现发现基本效果和微信的发图页面差不多，有一定的加载延迟，但是在可接受范围之类。<br>这里还是用universalImageLoader来作为加载图片的组件，定义一个gridView用来展示图片，gridView中定义两种不同布局，一个用来展示拍照，另一种用来展示遍历到的系统图片。<br>先看下实现效果：<br><img src="http://img.blog.csdn.net/20150526210605413" alt="这里写图片描述"><br>布局文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;? xml version= &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</div><div class="line">&lt; GridView</div><div class="line">    xmlns:android= &quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">      xmlns:tools= &quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id= &quot;@+id/gridView&quot;</div><div class="line">    android:paddingTop= &quot;1dp&quot;</div><div class="line">    android:layout_width= &quot;match_parent&quot;</div><div class="line">    android:layout_height= &quot;match_parent&quot;</div><div class="line">    android:numColumns= &quot;3&quot;</div><div class="line">      android:verticalSpacing= &quot;2dp&quot;</div><div class="line">      android:horizontalSpacing= &quot;2dp&quot;</div><div class="line">      android:stretchMode= &quot;columnWidth&quot; &gt;</div><div class="line">&lt;/ GridView&gt;</div></pre></td></tr></table></figure>
<p>java代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div></pre></td><td class="code"><pre><div class="line">public class ThumbnailActivity extends Activity &#123;</div><div class="line"></div><div class="line">     public static String TAG = &quot;Thumbnails&quot;;</div><div class="line"></div><div class="line">     public static final int TAKE_PHOTO = 10000;</div><div class="line"></div><div class="line">     public static final int SELECT_PHOTO = 10001;</div><div class="line"></div><div class="line">     private GridView gridView;</div><div class="line"></div><div class="line">     private GridAdapter adapter;</div><div class="line"></div><div class="line">     private int maxImageSelectCount;</div><div class="line"> </div><div class="line">     private List&lt;String&gt; selectedImages;</div><div class="line">     </div><div class="line">     private ImageLoader imageLoader = ImageLoader.getInstance();</div><div class="line">     </div><div class="line">     DisplayImageOptions options = new DisplayImageOptions.Builder()  </div><div class="line">     .showImageOnLoading(R.drawable.background_image_loading) //设置图片在下载期间显示的图片  </div><div class="line">     .cacheInMemory(false)//设置下载的图片是否缓存在内存中  </div><div class="line">     .cacheOnDisk(false)//设置下载的图片是否缓存在SD卡中  </div><div class="line">     .considerExifParams(true)  //是否考虑JPEG图像EXIF参数（旋转，翻转）</div><div class="line">     .imageScaleType(ImageScaleType.EXACTLY_STRETCHED)//设置图片以如何的编码方式显示  </div><div class="line">     .bitmapConfig(Bitmap.Config.RGB_565)//设置图片的解码类型//</div><div class="line">     .build();//构建完成  </div><div class="line">     </div><div class="line">     /**</div><div class="line">     * 拍照后照片存储地址</div><div class="line">     */</div><div class="line">     private Uri takePhotoUri;</div><div class="line"></div><div class="line">     // private static final String FILE_PATH =</div><div class="line">     // Environment.getExternalStorageDirectory().getPath();</div><div class="line"></div><div class="line">     @Override</div><div class="line">     public boolean onCreateOptionsMenu(Menu menu) &#123;</div><div class="line">          MenuInflater inflater = getMenuInflater();</div><div class="line">          inflater.inflate(R.menu.thumbnail, menu);</div><div class="line">          return super.onCreateOptionsMenu(menu);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     @Override</div><div class="line">     public boolean onOptionsItemSelected(MenuItem item) &#123;</div><div class="line">          switch (item.getItemId()) &#123;</div><div class="line">          case R.id.action_confirm:</div><div class="line">               Intent res = new Intent();</div><div class="line">               ArrayList&lt;String&gt; li = new ArrayList&lt;String&gt;();</div><div class="line">               for (String path : selectedImages) &#123;</div><div class="line">                    if (path != null)</div><div class="line">                         li.add(path);</div><div class="line">               &#125;</div><div class="line">               res.putExtra(&quot;tu_ji&quot;, li);</div><div class="line">               setResult(SELECT_PHOTO, res);</div><div class="line">               finish();</div><div class="line">               return true;</div><div class="line">          default:</div><div class="line">               return super.onOptionsItemSelected(item);</div><div class="line">          &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     @Override</div><div class="line">     protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">          super.onCreate(savedInstanceState);</div><div class="line">          setContentView(R.layout.activity_thumbnail);</div><div class="line">          selectedImages = new ArrayList&lt;String&gt;();</div><div class="line">          maxImageSelectCount = getIntent().getIntExtra(&quot;maxImageSelectCount&quot;, 1);</div><div class="line">          gridView = (GridView) findViewById(R.id.gridView);</div><div class="line">          adapter = new GridAdapter();</div><div class="line">          gridView.setAdapter(adapter);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     class GridAdapter extends BaseAdapter implements OnItemClickListener &#123;</div><div class="line"></div><div class="line">          private ArrayList&lt;PictureData&gt; list;</div><div class="line"></div><div class="line">          private TakePhotoClickListener takePhotoClickListener;</div><div class="line">          </div><div class="line">          private PhotoClickListener photoClickListener;</div><div class="line"></div><div class="line">          private CheckBoxListener checkBoxListener;</div><div class="line"></div><div class="line">          public GridAdapter() &#123;</div><div class="line">               checkBoxListener = new CheckBoxListener();</div><div class="line">               list = new ArrayList&lt;PictureData&gt;();</div><div class="line">               PictureData data = new PictureData();</div><div class="line">               list.add(data);</div><div class="line">               String str[] = &#123; MediaStore.Images.Media._ID,  </div><div class="line">                 MediaStore.Images.Media.DISPLAY_NAME,  </div><div class="line">                 MediaStore.Images.Media.DATA&#125;;  </div><div class="line">               Cursor cursor = ThumbnailActivity.this.getContentResolver().query(  </div><div class="line">                 MediaStore.Images.Media.EXTERNAL_CONTENT_URI, str,  </div><div class="line">                 null, null, null);  </div><div class="line">               getColumnData(cursor);</div><div class="line">               takePhotoClickListener = new TakePhotoClickListener();</div><div class="line">               photoClickListener = new PhotoClickListener();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          @Override</div><div class="line">          public int getCount() &#123;</div><div class="line">               return list.size();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          public ArrayList&lt;PictureData&gt; getList() &#123;</div><div class="line">               return list;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          public void setList(ArrayList&lt;PictureData&gt; list) &#123;</div><div class="line">               this.list = list;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          @Override</div><div class="line">          public Object getItem(int position) &#123;</div><div class="line">               return list.get(position);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          @Override</div><div class="line">          public long getItemId(int position) &#123;</div><div class="line">               return position;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          @Override</div><div class="line">          public View getView(int position, View convertView, ViewGroup parent) &#123;</div><div class="line">               switch (getItemViewType(position)) &#123;</div><div class="line">               case 0:</div><div class="line">                    if (convertView == null) &#123;</div><div class="line">                         LayoutInflater inflater = (LayoutInflater) getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">                         convertView = inflater.inflate(</div><div class="line">                                   R.layout.thumbnail_grid_take_photo, parent, false);</div><div class="line">                    &#125;</div><div class="line">                    convertView.setOnClickListener(takePhotoClickListener);</div><div class="line">                    break;</div><div class="line">               case 1:</div><div class="line">                    ViewHolder holder;</div><div class="line">                    if (convertView == null) &#123;</div><div class="line">                         LayoutInflater inflater = (LayoutInflater) getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">                         convertView = inflater.inflate(R.layout.thumbnail_grid,</div><div class="line">                                   parent, false);</div><div class="line">                         holder = new ViewHolder();</div><div class="line">                         holder.imageView = (ImageView) convertView</div><div class="line">                                   .findViewById(R.id.image);</div><div class="line">                         holder.checkBox = (CheckBox) convertView</div><div class="line">                                   .findViewById(R.id.select);</div><div class="line">                         convertView.setTag(holder);</div><div class="line">                    &#125; else &#123;</div><div class="line">                         holder = (ViewHolder) convertView.getTag();</div><div class="line">                    &#125;</div><div class="line">                    holder.checkBox.setTag(list.get(position));</div><div class="line">                    holder.checkBox.setOnCheckedChangeListener(checkBoxListener);</div><div class="line">                    holder.imageView.setOnClickListener(photoClickListener);</div><div class="line">                    imageLoader.displayImage(&quot;file://&quot; + list.get(position).imagePath, holder.imageView, options);</div><div class="line">                    break;</div><div class="line">               &#125;</div><div class="line">               return convertView;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          private void getColumnData(Cursor cur) &#123;</div><div class="line">               if (cur.moveToLast()) &#123;</div><div class="line">                    String image_path;</div><div class="line">                    do &#123;</div><div class="line">                         image_path = cur.getString(2);</div><div class="line"></div><div class="line">                         // Do something with the values.</div><div class="line">                         PictureData data = new PictureData();</div><div class="line">                         data.imagePath = image_path;</div><div class="line">                         list.add(data);</div><div class="line"></div><div class="line">                    &#125; while (cur.moveToPrevious());</div><div class="line"></div><div class="line">               &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          @Override</div><div class="line">          public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position,</div><div class="line">                    long id) </div><div class="line">          &#125;</div><div class="line"></div><div class="line">          class CheckBoxListener implements OnCheckedChangeListener &#123;</div><div class="line">               @Override</div><div class="line">               public void onCheckedChanged(CompoundButton buttonView,</div><div class="line">                         boolean isChecked) &#123;</div><div class="line">                    PictureData pictureData = (PictureData) buttonView.getTag();</div><div class="line">                    pictureData.isSelected = isChecked;</div><div class="line">                    if (isChecked) &#123;</div><div class="line">                         if (selectedImages.size() &gt;= maxImageSelectCount) &#123;</div><div class="line">                              Toast toast = Toast</div><div class="line">                                        .makeText(ThumbnailActivity.this, String</div><div class="line">                                                  .format(&quot;最多可选 %d 张&quot;,</div><div class="line">                                                            maxImageSelectCount),</div><div class="line">                                                  Toast.LENGTH_SHORT);</div><div class="line">                              toast.setGravity(Gravity.CENTER, 0, 0);</div><div class="line">                              toast.show();</div><div class="line">                              buttonView.setChecked(!isChecked);</div><div class="line">                         &#125; else &#123;</div><div class="line">                              selectedImages.add(pictureData.imagePath);</div><div class="line">                         &#125;</div><div class="line">                    &#125; else &#123;</div><div class="line">                         selectedImages.remove(pictureData.imagePath);</div><div class="line">                    &#125;</div><div class="line">               &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          class TakePhotoClickListener implements OnClickListener &#123;</div><div class="line">               </div><div class="line">               @Override</div><div class="line">               public void onClick(View v) &#123;</div><div class="line">                    takePhotoUri = ImageManager.takePhoto(ThumbnailActivity.this, TAKE_PHOTO);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">          &#125;</div><div class="line">          </div><div class="line">          class PhotoClickListener implements OnClickListener &#123;</div><div class="line">               </div><div class="line">               @Override</div><div class="line">               public void onClick(View v) &#123;</div><div class="line">//                    Intent intent = new Intent();  </div><div class="line">//                 /* 开启Pictures画面Type设定为image */  </div><div class="line">//                 intent.setType(&quot;image/*&quot;);  </div><div class="line">//                 /* 使用Intent.ACTION_GET_CONTENT这个Action */  </div><div class="line">//                 intent.setAction(Intent.ACTION_GET_CONTENT);   </div><div class="line">//                 /* 取得相片后返回本画面 */  </div><div class="line">//                 startActivityForResult(intent, 1);  </div><div class="line">               &#125;</div><div class="line"></div><div class="line">          &#125;</div><div class="line"></div><div class="line">          @Override</div><div class="line">          public int getItemViewType(int position) &#123;</div><div class="line">               if (position == 0) &#123;</div><div class="line">                    return 0;</div><div class="line">               &#125; else &#123;</div><div class="line">                    return 1;</div><div class="line">               &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          @Override</div><div class="line">          public int getViewTypeCount() &#123;</div><div class="line">               return 2;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          class ViewHolder &#123;</div><div class="line">               ImageView imageView;</div><div class="line">               CheckBox checkBox;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">     &#125;</div><div class="line"></div><div class="line">     @Override</div><div class="line">     public void onActivityResult(int requestCode, int resultCode, Intent data) &#123;</div><div class="line">          // 拍照返回</div><div class="line">          if (requestCode == TAKE_PHOTO) &#123;</div><div class="line">               Intent res = new Intent();</div><div class="line">               res.setData(takePhotoUri);</div><div class="line">               setResult(TAKE_PHOTO, res);</div><div class="line">               finish();</div><div class="line">          &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     public GridAdapter getAdapter() &#123;</div><div class="line">          return adapter;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     public void setAdapter(GridAdapter adapter) &#123;</div><div class="line">          this.adapter = adapter;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     class PictureData &#123;</div><div class="line">          String imagePath;</div><div class="line">          boolean isSelected;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有兴趣的同学也可以去豌豆荚搜索“布板”或扫描二维码下载android的demo版试用看看，欢迎小伙伴们和我一起讨论交流。<br><img src="http://img.blog.csdn.net/20150522000631480" alt="这里写图片描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/26/从零开始打造一个新闻订阅APP之Android篇（三、关于图片加载、展示的那些事）/" itemprop="url">
                  从零开始打造一个新闻订阅APP之Android篇（三、关于图片加载、展示的那些事）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-05-26T19:43:36+08:00" content="2015-05-26">
              2015-05-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在上一篇文章 <a href="http://xihuxiaolongren.com/2015/05/22/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E6%96%B0%E9%97%BB%E8%AE%A2%E9%98%85APP%E4%B9%8BAndroid%E7%AF%87%EF%BC%88%E4%BA%8C%E3%80%81%E4%BB%8E%E2%80%9C%E9%80%9B%E2%80%9D%E9%A1%B5%E9%9D%A2%E8%B0%88%E8%B0%88%E5%A4%9A%E7%A7%8D%E6%A0%BC%E5%BC%8Flistview%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82%EF%BC%89/">如何开发一个新闻订阅APP之Android篇（二、从“逛”页面谈谈多种格式listview的实现细节）</a>中，我介绍了lsitView的多种布局的实现细节，这其中包含了很多图片的显示。其实当前比较流行的APP中，随处可见大量的图片，这里把自己遇到的一些问题总结出来，<br>简单的加载图片通常需要注意以下两个细节：<br>1、在开发android程序时，如果你在UI线程，也就是主线程中做了类似于网络连接这些事的时候，程序是不能运行的。因为android的开发规范要求，主UI线程不允许处理一些耗时任务，如果需要连接网络获取数据，你需要在子线程中完成这件事。android提供了Handler和AsyncTask等封装好的异步消息处理机制。它们使得你非常方便的在子线程和UI线程之间进行通信和切换。关于AsyncTask，这篇文章讲的非常透彻 <a href="http://blog.csdn.net/guolin_blog/article/details/11711405" target="_blank" rel="external">Android AsyncTask完全解析，带你从源码的角度彻底理解</a>，这里就不多赘述了。</p>
<p>2、这个列表页有很多的图片。很容易想象，手机的内存资源是很宝贵的，如果不对内存加以控制，可能APP很快就会出现OOM错误。控制内存溢出有很多方法，一般来讲，都是利用缓存机制，通常有内存缓存和Disk缓存两层控制即可。<br>对于程序中图片的内存控制问题，这篇博文同样讲的非常透彻：<br><a href="http://blog.csdn.net/guolin_blog/article/details/9316683" target="_blank" rel="external">Android高效加载大图、多图解决方案，有效避免程序OOM</a></p>
<p>除此之外，初学者很可能会遇到的一个坑是图片的大小和imageView大小之间的关系。如果你将一张大于屏幕大小的图片不经处理直接加载到imageView中，这本身没有什么问题，图片会根据你的imageView的设置自动缩放（除非单张图片直接超过了android默认的内存限制，图片会无法显示），但是可能依据你的程序实现会出现不同的问题。在我的程序中一开始出现的问题是listView滑动会特别卡，通过日志打印，发现图片平均每张接近7,80KB，可是这也不大啊。但在debug程序的时候，发现LRUCache只能保存5个左右的图片，已经用掉20MB内存了，这个时候终于恍然大悟，图片加载到内存中显示，和存储大小完全是两个概念，因为现在无论什么格式的图片，几乎都实现了很大的压缩。而在服务器端开发的时候，基本没有考虑过图片显示的时候需要的内存大小，只需要传给浏览器，怎么显示都是客户端的问题了。<br>因为这个原因，LRUCache的命中非常低，几乎无用了，然后，DiskLRUCache在并发访问过大时，特别是有很多写入请求的时候，会特别卡。所以，你需要根据你的imageView大小来控制加载到内存中的图片大小；</p>
<p>ok，上面讲到的都是自己在实现加载图片的过程中遇到的一些问题。接下来，给新手们介绍一个开源图片加载神器Android-Universal-Image-Loader。如果你一开始用的就是它来实现加载图片，上面所有问题几乎都不会遇到。因为这个组件全部帮你搞定了，包括网络请求，缓存，图片大小自适应，图片释放等等问题；<br>但对于初学者而言，我还是推荐大家按照<a href="http://blog.csdn.net/guolin_blog/article/details/9316683" target="_blank" rel="external">Android高效加载大图、多图解决方案，有效避免程序OOM</a>这篇文章学习并自己先实现下图片加载和缓存处理，结合DDMS等内存分析工具排查这个过程遇到的问题，可以帮助你深入的理解android图片处理这一块的细节实现。</p>
<p>最后，再给大家推荐一个非常棒的图片<a href="https://github.com/daimajia/AndroidImageSlider" target="_blank" rel="external">轮播组件</a>。<br><img src="http://uisource.com/wp-content/uploads/2014/06/Android-Image-Slider.gif" alt="这里写图片描述"><br>效果非常炫，不过我下载的版本存在一个问题，它默认使用的picasso作为图片加载和缓存的组件，但在使用过程中发现这个组件吃内存比较严重，找了很久无法解决问题。最后只能自己修改源代码，把用到picasso的地方用Universal-Image-Loader替代了之后，内存开销恢复了正常水平。（其中一个重要原因是整个APP使用Universal-Image-Loader统一了缓存的管理）。<br>好了，关于图片的一些细节就介绍到这里，最后还是推销下自己开发的APP，有兴趣的同学也可以去豌豆荚搜索“布板”或扫描二维码下载android的demo版试用看看，欢迎小伙伴们和我一起讨论交流。<br><img src="http://img.blog.csdn.net/20150522000631480" alt="这里写图片描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/22/从零开始打造一个新闻订阅APP之Android篇（二、从“逛”页面谈谈多种格式listview的实现细节）/" itemprop="url">
                  从零开始打造一个新闻订阅APP之Android篇（二、从“逛”页面谈谈多种格式listview的实现细节）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-05-22T21:45:19+08:00" content="2015-05-22">
              2015-05-22
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇文章<a href="http://xihuxiaolongren.com/2015/05/22/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E6%96%B0%E9%97%BB%E8%AE%A2%E9%98%85APP%E4%B9%8BAndroid%E7%AF%87%EF%BC%88%E4%B8%80%E3%80%81%E5%AE%9E%E7%8E%B0%E4%BB%BF%E5%BE%AE%E4%BF%A1%E4%B8%BB%E7%95%8C%E9%9D%A2%E6%95%88%E6%9E%9C%EF%BC%89/">如何开发一个新闻订阅APP之Android篇（一、实现仿微信主界面效果）</a><br>介绍了布板主界面的实现，接下来，我想和大家分享一下ListView的一些使用心得。<br>listview是客户端最最常见的组件之一，它以列表的形式展示一组数据。android对listview做了很好的优化，即使你的list被用来展现成千上万的数据，对于listview来说，只会生成少量的列表项，具体的数量会视你的屏幕可见区域长度和每一个列表项的高度而定。至于实现原理，这里推荐一篇<a href="http://www.cnblogs.com/xiangtailiang/p/3379543.html" target="_blank" rel="external">ListView中convertView和ViewHolder的工作原理</a></p>
<p>一个简单的列表页面java代码实现需要如下：<br>一个listview<br>一个adapter<br>一组待展示数据</p>
<p>但是界面的设计是丰富多样的，通常一个listview可能会需要显示多种不同的格式。这里推荐直接继承BaseAdapter，因为稍微复杂一点的listview，继承BaseAdapter可以支持你自定义列表加载，显示等等细节实现；<br>特别注意的一点是，其实无论需要展示多少种类型的布局，你都可以在getView中，针对每条数据，生成不同格式的布局；那为什么android还要提供getViewTypeCount和getItemViewType这两个方法来让你在实现多种布局时必须重载呢？<br>最主要的原因是：配合getView参数中的convertView，重复利用已有的view布局，展示不同的数据。当你实现了上述两个方法后，listview会调用这些函数，确定你需要的不同类型的布局个数，当listview需要显示某一种类型的布局时，它会根据getItemViewType来判断是否已经缓存了相同类型的布局，如果是，则传入convertView，否则，生成一个新的view；<br>那么问题又来了：为什么要用convertView？唯一的因素是：更快，如果为每一条数据生成一个新的View会耗费很长的时间，用户在上下滑动会造成卡顿现象，<br>此外，ViewHolder的模式也是为了在切换列表项时，当已经存在一个缓存的view情况下（即convertView不为空），避免使用findViewById带来的性能开销，优化listView的流畅性；<br>下面是部分代码，newsList是数据列表；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public int getItemViewType(int position) &#123;</div><div class="line">     News news = newsList. get( position) ;</div><div class="line">     int type = news. getType() ;</div><div class="line">     return type;</div><div class="line">&#125;</div><div class="line">@Override</div><div class="line">public int getViewTypeCount() &#123;</div><div class="line">     return TYPE_COUNT;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">public int getCount() &#123;</div><div class="line">     return newsList. size() ;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">public View getView( int position, View convertView, ViewGroup parent ) &#123;</div><div class="line">      News news = newsList. get( position) ;</div><div class="line">      int type = getItemViewType (position );</div><div class="line">      switch (type ) &#123;</div><div class="line">      case TYPE_TEXT:</div><div class="line">            return getTextConvertView (convertView , parent, news , position );</div><div class="line">      case TYPE_PIC:</div><div class="line">            return getPicConvertView (convertView , parent, news , position );</div><div class="line">      case TYPE_VOTE:</div><div class="line">            return getVoteConvertView (convertView , parent, news , position );</div><div class="line">      case TYPE_HU_TEXT :</div><div class="line">            return getHuTextConvertView (convertView , parent, news , position) ;</div><div class="line">      case TYPE_HU_PIC :</div><div class="line">            return getHuPicConvertView (convertView , parent, news , position );</div><div class="line">      &#125;</div><div class="line">      return convertView ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重写getView，个人习惯是根据当前列表项的布局类型，调用不同的方法，这样代码结构看上去比较清晰；<br>其实究竟要区分多少种不同的类型，取决于你的每一种类型是否是可以扩展布局类型。举例来说：微信朋友圈每一个状态可以显示的图片最多9张，显示类型为3<em>3。最少则只有文字，需要多少种类型的布局呢？<br>答案是只需要<em>*一种</em></em>类型的布局。如何实现？<br>首先，定义好三层linearlayout和9个imageView，每一层包含三个imageView，假设当前列表项只有文字，则将三个linearLayout的visibility都设置为gone；只有一张图片，则将第一层linearlayout和第一个imageView的visibility设置为visible；即显示N张图片，即将相应前N个imageView设置为可见（至于每一层中后续的imageView的visibility是设置为gone还是invisible，取决于你希望显示的图片类型是铺满屏幕，还是固定大小），每超过一行显示个数，则相应设置新的一行linearlayout为visible即可。</p>
<p>而涉及到完全不同的两种布局，比如微信的<strong>分享</strong>和通过手机发的<strong>个人状态</strong>两种类型，则需要定义两种类型的布局，这是因为在显示一个刚刚进入屏幕的列表项时，可以直接配合ViewHolder，使用之前已经缓存过的convertView；<br>下面是效果图，界面滑动效果还是非常流畅的，并且支持了比较丰富的布局类型：<br><img src="http://img.blog.csdn.net/20150522214313856" alt="这里写图片描述"><br>现在稍微好一点的android机型，在listView中加载再多的文字基本不存在任何问题，但是显示图片仍然需要注意内存开销，特别是像上述界面中显示大量图片的场景。下一篇，我将介绍关于图片加载的一些实现细节。<br>有兴趣的同学也可以去豌豆荚搜索“布板”或扫描二维码下载android的demo版试用看看，欢迎小伙伴们和我一起讨论交流。<br><img src="http://img.blog.csdn.net/20150522000631480" alt="这里写图片描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/22/从零开始打造一个新闻订阅APP之Android篇（一、实现仿微信主界面效果）/" itemprop="url">
                  从零开始打造一个新闻订阅APP之Android篇（一、实现仿微信主界面效果）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-05-22T00:07:03+08:00" content="2015-05-22">
              2015-05-22
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>微信作为面向大众的产品，它的界面一直保持简洁的风格，实现布板的主界面时也参考了很多APP的设计，最终决定采用类似于微信的主界面，即四个tab滑动。<br>google了一把之后，找到了一款滑动利器PagerSlidingTabStrip。<br>官网地址：<a href="https://github.com/astuetz/PagerSlidingTabStrip" target="_blank" rel="external">https://github.com/astuetz/PagerSlidingTabStrip</a><br>官方效果图如下：<br><img src="https://camo.githubusercontent.com/e39d7a7c9c815b737d15ee1a62863425579b6446/68747470733a2f2f6c68332e67677068742e636f6d2f50585337456d4868515a6454314f613337396979393148583342795741516e465a4174684d4146615f5148414f484e436c45615855356e784445416a3146326571626b" alt="这里写图片描述"><br>但使用过程中发现想要把滑动tab放到底部更改布局相当麻烦，后来自己思考并结合了guolin大神的一篇介绍Fragment的文章 <a href="http://blog.csdn.net/guolin_blog/article/details/13171191" target="_blank" rel="external">Android Fragment应用实战，使用碎片向ActivityGroup说再见</a>，终于完美地实现了想要的效果，如下是最终的效果图：<br><img src="http://img.blog.csdn.net/20150522000538101" alt="这里写图片描述"><br>首先新建一个activity_main.xml布局文件，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools= &quot;http://schemas.android.com/tools&quot;</div><div class="line">    xmlns:pagerslidingtabstrip=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    android:layout_width= &quot;match_parent&quot;</div><div class="line">    android:layout_height= &quot;match_parent&quot;</div><div class="line">    android:background= &quot;@color/mainbackground&quot;</div><div class="line">    android:clipChildren= &quot;false&quot;</div><div class="line">    android:clipToPadding= &quot;false&quot;</div><div class="line">    &gt;</div><div class="line">     &lt;com.astuetz.PagerSlidingTabStrip</div><div class="line">        android:id= &quot;@+id/mainTabs&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;10dp&quot;</div><div class="line">        android:visibility=&quot;gone&quot;</div><div class="line">        /&gt;</div><div class="line">     &lt;android.support.v4.view.ViewPager</div><div class="line">        android:id= &quot;@+id/mainPager&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        /&gt;</div><div class="line">     </div><div class="line">     &lt;LinearLayout</div><div class="line">         android:layout_alignParentBottom=&quot;true&quot;</div><div class="line">         android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;50dp&quot;</div><div class="line">         android:clipChildren=&quot;false&quot;</div><div class="line">     android:clipToPadding= &quot;false&quot;</div><div class="line">     android:background= &quot;@color/mainbackground&quot;</div><div class="line">     android:baselineAligned= &quot;false&quot;</div><div class="line">         &gt;</div><div class="line">            &lt;LinearLayout</div><div class="line">               android:id= &quot;@+id/onlyYou&quot;</div><div class="line">               android:layout_width=&quot;0dp&quot;</div><div class="line">               android:layout_weight=&quot;1&quot;</div><div class="line">               android:layout_height=&quot;match_parent&quot;</div><div class="line">               android:gravity=&quot;center&quot;</div><div class="line">               android:orientation=&quot;vertical&quot;</div><div class="line">               &gt;</div><div class="line">               &lt;ImageView</div><div class="line">                 android:id= &quot;@+id/onlyYouImage&quot;</div><div class="line">                 android:layout_width=&quot;25dp&quot;</div><div class="line">                 android:layout_height=&quot;25dp&quot;</div><div class="line">                 /&gt;</div><div class="line">             &lt;TextView</div><div class="line">                 android:id= &quot;@+id/onlyYouText&quot;</div><div class="line">                 android:textSize=&quot;10sp&quot;</div><div class="line">                 android:text=&quot;@string/onlyyou&quot;</div><div class="line">                 android:layout_width=&quot;wrap_content&quot;</div><div class="line">                 android:layout_height=&quot;wrap_content&quot;</div><div class="line">                /&gt;</div><div class="line">            &lt;/LinearLayout&gt;</div><div class="line">            &lt;LinearLayout</div><div class="line">               android:id= &quot;@+id/guang&quot;</div><div class="line">               android:layout_width=&quot;0dp&quot;</div><div class="line">               android:layout_weight=&quot;1&quot;</div><div class="line">               android:gravity=&quot;center&quot;</div><div class="line">               android:layout_height=&quot;match_parent&quot;</div><div class="line">               android:orientation=&quot;vertical&quot;</div><div class="line">               &gt;</div><div class="line">               &lt;ImageView</div><div class="line">                 android:id= &quot;@+id/guangImage&quot;</div><div class="line">                 android:layout_width=&quot;25dp&quot;</div><div class="line">                 android:layout_height=&quot;25dp&quot;</div><div class="line">                 /&gt;</div><div class="line">             &lt;TextView</div><div class="line">                 android:id= &quot;@+id/guangText&quot;</div><div class="line">                 android:textSize=&quot;10sp&quot;</div><div class="line">                 android:text=&quot;@string/guang&quot;</div><div class="line">                 android:layout_width=&quot;wrap_content&quot;</div><div class="line">                 android:layout_height=&quot;wrap_content&quot;</div><div class="line">                /&gt;</div><div class="line">            &lt;/LinearLayout&gt;</div><div class="line">            &lt;LinearLayout</div><div class="line">               android:id= &quot;@+id/find&quot;</div><div class="line">               android:layout_width=&quot;0dp&quot;</div><div class="line">               android:layout_weight=&quot;1&quot;</div><div class="line">               android:layout_height=&quot;match_parent&quot;</div><div class="line">               android:orientation=&quot;vertical&quot;</div><div class="line">               android:gravity=&quot;center&quot;</div><div class="line">               &gt;</div><div class="line">               &lt;ImageView</div><div class="line">                 android:id= &quot;@+id/findImage&quot;</div><div class="line">                 android:layout_width=&quot;25dp&quot;</div><div class="line">                 android:layout_height=&quot;25dp&quot;</div><div class="line">                 /&gt;</div><div class="line">             &lt;TextView</div><div class="line">                 android:id= &quot;@+id/findText&quot;</div><div class="line">                 android:textSize=&quot;10sp&quot;</div><div class="line">                 android:text=&quot;@string/find&quot;</div><div class="line">                 android:layout_width=&quot;wrap_content&quot;</div><div class="line">                 android:layout_height=&quot;wrap_content&quot;</div><div class="line">                /&gt;</div><div class="line">            &lt;/LinearLayout&gt;</div><div class="line">            &lt;LinearLayout</div><div class="line">               android:id= &quot;@+id/me&quot;</div><div class="line">               android:layout_width=&quot;0dp&quot;</div><div class="line">               android:layout_weight=&quot;1&quot;</div><div class="line">               android:layout_height=&quot;match_parent&quot;</div><div class="line">               android:orientation=&quot;vertical&quot;</div><div class="line">               android:gravity=&quot;center&quot;</div><div class="line">               &gt;</div><div class="line">               &lt;ImageView</div><div class="line">                 android:id= &quot;@+id/meImage&quot;</div><div class="line">                 android:layout_width=&quot;25dp&quot;</div><div class="line">                 android:layout_height=&quot;25dp&quot;</div><div class="line">                 /&gt;</div><div class="line">             &lt;TextView</div><div class="line">                 android:id= &quot;@+id/meText&quot;</div><div class="line">                 android:textSize=&quot;10sp&quot;</div><div class="line">                 android:text=&quot;@string/me&quot;</div><div class="line">                 android:layout_width=&quot;wrap_content&quot;</div><div class="line">                 android:layout_height=&quot;wrap_content&quot;</div><div class="line">                /&gt;</div><div class="line">            &lt;/LinearLayout&gt;</div><div class="line">     &lt;/LinearLayout &gt;</div><div class="line">&lt;/RelativeLayout&gt;</div></pre></td></tr></table></figure></p>
<p>这段代码中，10-20行是引入PagerSlidingTabStrip+ViewPager用来实现滑动效果，而22-115行就是底部的一行导航Tab。注意这里由于不使用PagerSlidingTabStrip的导航Tab，直接将其visibility设置为gone即可。<br>接下来新建MainActivity.java文件，在onCreate方法中完成初始化工作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">@Override </div><div class="line">    protected void onCreate (Bundle savedInstanceState) &#123;  </div><div class="line">     noSelectColorId = getResources().getColor( R. color.noSelectColor );</div><div class="line">     selectColorId = getResources().getColor( R. color.selectColor );</div><div class="line">        super.onCreate (savedInstanceState );</div><div class="line">       </div><div class="line">        setContentView(R .layout.activity_main) ;</div><div class="line">       </div><div class="line">        //检查版本更新</div><div class="line">        UpdateManager.update (this);</div><div class="line">       </div><div class="line">        mViewPager = (ViewPager) findViewById (R.id. mainPager) ;</div><div class="line">        onMainClickListener = new OnMainClickListener ();</div><div class="line">        onlyYou = (View) findViewById (R.id. onlyYou) ;</div><div class="line">        onlyYouText = (TextView) findViewById (R.id. onlyYouText);</div><div class="line">        onlyYouImage = (ImageView) findViewById(R .id.onlyYouImage) ;</div><div class="line">        onlyYou. setTag( 0) ;</div><div class="line">        onlyYou. setOnClickListener(onMainClickListener );</div><div class="line">        onlyYouText.setTextColor (selectColorId );</div><div class="line">        guang = (View) findViewById (R.id. guang) ;</div><div class="line">        guang. setTag( 1) ;</div><div class="line">        guang. setOnClickListener(onMainClickListener );</div><div class="line">        guangText = (TextView) findViewById (R.id. guangText) ;</div><div class="line">        guangImage = (ImageView) findViewById (R.id. guangImage) ;</div><div class="line">        find = (View) findViewById (R.id. find) ;</div><div class="line">        find. setTag( 2) ;</div><div class="line">        find. setOnClickListener(onMainClickListener );</div><div class="line">        findText = (TextView) findViewById (R.id. findText) ;</div><div class="line">        findImage = (ImageView) findViewById (R.id. findImage) ;</div><div class="line">        me = (View) findViewById (R.id. me) ;</div><div class="line">        me. setTag( 3) ;</div><div class="line">        me. setOnClickListener(onMainClickListener );</div><div class="line">        meText = (TextView) findViewById (R.id. meText) ;</div><div class="line">        meImage = (ImageView) findViewById (R.id. meImage) ;</div><div class="line">       </div><div class="line">        onlyYouText.setTextColor (selectColorId );</div><div class="line">            guangText. setTextColor(noSelectColorId );</div><div class="line">            findText. setTextColor(noSelectColorId );</div><div class="line">            meText. setTextColor(noSelectColorId );</div><div class="line">           onlyYouImage.setBackgroundResource (R.drawable. icon_onlyyou_select);</div><div class="line">           guangImage. setBackgroundResource(R .drawable.icon_guang_no_select) ;</div><div class="line">           findImage. setBackgroundResource(R .drawable.icon_find_no_select) ;</div><div class="line">           meImage. setBackgroundResource(R .drawable.icon_me_no_select) ;</div><div class="line">           </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里有一个小的细节，由于在顶部导航栏中，我的其中一个Fragment需要加入不同的按钮，本以为是个非常简单的事情，后来发现这是一个大坑，在stackoverflow上有一个专门的讨论，但貌似实现起来都非常麻烦。目前程序必须限制只能竖屏，否则在横竖屏切换时会崩溃，这个后续有机会再介绍，这里不是重点。<br>还是由于顶部导航栏的原因，初始化viewPager工作放在了onCreateOptionsMenu 中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">     public boolean onCreateOptionsMenu (Menu menu ) &#123;</div><div class="line">     MenuInflater inflater = getMenuInflater(); </div><div class="line">         inflater. inflate( R. menu.main , menu) ;</div><div class="line">         switchTypeItem = menu .getItem (0 );</div><div class="line">         adapter = new MainAdapter(getSupportFragmentManager ());</div><div class="line">         mViewPager. setAdapter( adapter) ;</div><div class="line">         mViewPager. setOffscreenPageLimit(4);</div><div class="line">         mViewPager. setOnPageChangeListener(new MyOnPageChangeListener());</div><div class="line">         if( personLoaclInfoManager.getUserInfo (). getIsLogin() != 1)&#123;</div><div class="line">             mViewPager. setCurrentItem(1);</div><div class="line">         &#125;else&#123;</div><div class="line">             mViewPager. setCurrentItem(0);</div><div class="line">         &#125;</div><div class="line">             return super .onCreateOptionsMenu (menu );</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>Tips：<br>adapter = new MainAdapter (getSupportFragmentManager ());<br>mViewPager. setAdapter( adapter)  ;//这两行设置viewPager的Fragment管理<br>mViewPager. setOffscreenPageLimit (4);//用来设置缓存view 的个数<br>mViewPager. setCurrentItem (1);//设置当前显示第几页，从0开始；<br>mViewPager. setOnPageChangeListener (new MyOnPageChangeListener ());//设置page切换时的监听事件；</p>
<p>MainAdapter很简单，只需要继承FragmentPagerAdapter，初始化Fragment，然后重载getItem(int position)，指定每页对应的Fragment即可；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">class MainAdapter extends FragmentPagerAdapter &#123;</div><div class="line">     </div><div class="line">        private CharSequence [] mTitles;</div><div class="line">       </div><div class="line">        private int COUNT = 4 ;</div><div class="line">      </div><div class="line">        public MainAdapter (FragmentManager fm) &#123;</div><div class="line">            super(fm);</div><div class="line">            mTitles = getResources().getStringArray( R. array.main_bottom_array );</div><div class="line">            onlyYouFragment = new OnlyYouFragment(switchTypeItem , MainActivity.this );</div><div class="line">            guangFragment = new GuangFragment ();</div><div class="line">            findFragment = new FindFragment ();</div><div class="line">            mefragment = new MeFragment() ;</div><div class="line">        &#125;</div><div class="line">       </div><div class="line">        // ViewPager中显示的内容</div><div class="line">        @Override</div><div class="line">        public Fragment getItem(int position) &#123;</div><div class="line">            switch(position )&#123;</div><div class="line">                 case 0:</div><div class="line">                      return onlyYouFragment ;</div><div class="line">                 case 1:</div><div class="line">                      return guangFragment ;</div><div class="line">                 case 2:</div><div class="line">                      return findFragment ;</div><div class="line">                 default :</div><div class="line">                      return mefragment ;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">       </div><div class="line">        // Title中显示的内容</div><div class="line">        @Override</div><div class="line">        public CharSequence getPageTitle(int position) &#123;</div><div class="line">            return mTitles [position ];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public int getCount() &#123;</div><div class="line">            return COUNT ;</div><div class="line">        &#125;</div><div class="line">       </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>等等，微信滑动时，每个tab颜色都会变化，当前页标签会变亮，其它则变暗。这里由于没有用PagerSlidingTabStrip自带的导航tab，所以我们需要自己监听页面变化，并改变相应底部tab颜色，具体监听事件代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">class MyOnPageChangeListener implements OnPageChangeListener&#123;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onPageScrolled(int position, float positionOffset,</div><div class="line">                      int positionOffsetPixels) &#123;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onPageSelected(int position) &#123;</div><div class="line">                 onlyYouText.setTextColor (noSelectColorId );</div><div class="line">                 guangText. setTextColor(noSelectColorId );</div><div class="line">                 findText. setTextColor(noSelectColorId );</div><div class="line">                 meText. setTextColor(noSelectColorId );</div><div class="line">                 onlyYouImage.setBackgroundResource (R.drawable. icon_onlyyou_no_select);</div><div class="line">                 guangImage. setBackgroundResource(R .drawable.icon_guang_no_select) ;</div><div class="line">                 findImage. setBackgroundResource(R .drawable.icon_find_no_select) ;</div><div class="line">                 meImage. setBackgroundResource(R .drawable.icon_me_no_select) ;</div><div class="line">                 switch(position )&#123;</div><div class="line">                 case 0:</div><div class="line">                      onlyYouText.setTextColor (selectColorId );</div><div class="line">                      onlyYouImage.setBackgroundResource (R.drawable. icon_onlyyou_select);</div><div class="line">                      switchTypeItem.setVisible (true);</div><div class="line">                      switchTypeItem.setEnabled (true);</div><div class="line">                      onlyYouFragment.refreshView ();</div><div class="line">                      break;</div><div class="line">                 case 1:</div><div class="line">                      guangText. setTextColor(selectColorId );</div><div class="line">                      guangImage. setBackgroundResource(R .drawable.icon_guang_select) ;</div><div class="line">                      switchTypeItem.setVisible (false);</div><div class="line">                      switchTypeItem.setEnabled (false);</div><div class="line">                      break;</div><div class="line">                 case 2:</div><div class="line">                      findText. setTextColor(selectColorId );</div><div class="line">                      findImage. setBackgroundResource(R .drawable.icon_find_select) ;</div><div class="line">                      switchTypeItem.setVisible (false);</div><div class="line">                      switchTypeItem.setEnabled (false);</div><div class="line">                      break;</div><div class="line">                 case 3:</div><div class="line">                      meText. setTextColor(selectColorId );</div><div class="line">                      meImage. setBackgroundResource(R .drawable.icon_me_select) ;</div><div class="line">                      switchTypeItem.setVisible (false);</div><div class="line">                      switchTypeItem.setEnabled (false);</div><div class="line">                      break;</div><div class="line">                 &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onPageScrollStateChanged(int state) &#123;</div><div class="line">                </div><div class="line">            &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在onPageSelected(int position)中，改变对于tab的颜色。<br>同时，点击每个tab也要相应切换到对应Fragment</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">class OnMainClickListener implements OnClickListener&#123;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onClick(View v) &#123;</div><div class="line">                 switch((Integer )v .getTag ())&#123;</div><div class="line">                      case 0:</div><div class="line">                            mViewPager. setCurrentItem(0);</div><div class="line">                            break;</div><div class="line">                      case 1:</div><div class="line">                            mViewPager. setCurrentItem(1);</div><div class="line">                            break;</div><div class="line">                      case 2:</div><div class="line">                            mViewPager. setCurrentItem(2);</div><div class="line">                            break;</div><div class="line">                      case 3:</div><div class="line">                            mViewPager. setCurrentItem(3);</div><div class="line">                            break;</div><div class="line">                      default:</div><div class="line">                            mViewPager. setCurrentItem(0);</div><div class="line">                 &#125;</div><div class="line">                </div><div class="line">            &#125;</div><div class="line">     </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>有兴趣的同学也可以去豌豆荚搜索“布板”或扫描二维码下载android的demo版试用看看，欢迎大家一起讨论。<br><img src="http://img.blog.csdn.net/20150522000631480" alt="这里写图片描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/20/从零开始打造一个新闻订阅APP之服务器篇（一、系统结构设计-开发流程简介）/" itemprop="url">
                  从零开始打造一个新闻订阅APP之服务器篇（一、系统结构设计&开发流程简介）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-05-20T20:53:43+08:00" content="2015-05-20">
              2015-05-20
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍布板的后端（服务器端）实现，布板是一个新闻订阅APP，有兴趣的小伙伴可以看看我之前的两篇文章<br><a href="http://xihuxiaolongren.com/2015/05/18/%E5%88%9B%E4%B8%9A%E6%A2%A6%E7%9A%84%E7%A0%B4%E7%A2%8E/">“创业梦”的破碎</a><br><a href="http://xihuxiaolongren.com/2015/05/18/%E5%B8%83%E6%9D%BF%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/">布板的前世今生</a><br>可以对整个项目有个大概的了解。<br>服务器端整体分为以下五个模块<br><img src="http://img.blog.csdn.net/20150520204425529" alt="这里写图片描述"><br>系统结构图如下：<br><img src="http://img.blog.csdn.net/20150520204512938" alt="这里写图片描述"><br>自下而上来看，<br>base-web层只负责接收http请求，解析请求并分发到对应的处理模块；<br>base-biz是整个系统最重要的一层,负责所有的业务逻辑处理，它的内部目前只分了两层：module层类似于一个个逻辑入口，对应一类请求，并调用一个或多个manager的方法，封装返回结果，manager层则是一个个的业务逻辑层，例如：CategoryManager 就是专门管理所有和类目相关的数据增删改查，权限处理，缓存调用，等等；<br>base-dao即数据访问层，主要负责和数据库的交互；<br>base-cao是缓存访问层，在上图中未体现出来，主要是自己目前对于缓存的使用规范还不太熟悉，目前的开发经验是：缓存尽量简单使用，当然，如果你确实有一块非常复杂但又追求性能的业务需要用缓存实现的话，可以专门写一个小模块进行管理；<br>base-common则用来存放一些共用的常量，工具类，数据等；</p>
<p>服务端的开发过程是首先定义好上述一个整体框架，之后基本是按照需求来开发，自顶而下的开发方式，需要实现一个功能，定义好客户端展现方式，和服务端交互接口，服务端增加一个module，在涉及到的1到N个manager中增加逻辑处理的方法，如果涉及到数据库，再在对应的dao层中增加一个数据库操作逻辑；</p>
<p>由于开发过程在前期基本以功能需求为主，绝大多数的开发过程都是比较枯燥的，后续如果想起有比较好的实现细节再详细和大家分享吧。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/19/从零开始打造一个新闻订阅APP之爬虫篇（二、实现一个简单的爬虫系统）/" itemprop="url">
                  从零开始打造一个新闻订阅APP之爬虫篇（二、实现一个简单的爬虫系统）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-05-19T21:29:32+08:00" content="2015-05-19">
              2015-05-19
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前景提要：<a href="http://xihuxiaolongren.com/2015/05/18/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E6%96%B0%E9%97%BB%E8%AE%A2%E9%98%85APP%E4%B9%8B%E7%88%AC%E8%99%AB%E7%AF%87%EF%BC%88%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%EF%BC%89/">如何开发一个新闻订阅APP之爬虫篇（一、背景介绍&amp;需求分析）</a><br>做一个特定的爬虫系统，首先考虑它要做什么？<br>从互联网上抓取指定的N个站点信息，解析提取需要的内容，按照特定的结构存储；<br>系统结构图如下：<br><img src="http://img.blog.csdn.net/20150520202749655" alt="这里写图片描述"><br>下面是主要的代码结构；<br><img src="http://img.blog.csdn.net/20150519212736753" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20150519212757938" alt="这里写图片描述"><br>首先，定义一个CrawlerBootStrap类，作为整个系统的主入口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">public void init()&#123;</div><div class="line">     crawlerList = new ArrayList &lt;Crawler &gt;() ;</div><div class="line">     for( String name : crawlerNameList )&#123;</div><div class="line">          Crawler c = (Crawler ) SpringUtil. getObject( name) ;</div><div class="line">          if( c. init())</div><div class="line">               crawlerList .add (c );</div><div class="line">     &#125;</div><div class="line">     start() ;</div><div class="line">&#125;</div><div class="line">//爬虫线程池，存储多个爬虫，控制同一时间正在运行爬虫个数</div><div class="line">public void start()&#123;</div><div class="line">      //爬虫池</div><div class="line">      int corePoolSize = 20 ;</div><div class="line">      int maximumPoolSize = 1000 ;</div><div class="line">      long keepAliveTime = 100000L ;</div><div class="line">      BlockingQueue &lt;Runnable &gt; runnableTaskQueue = new PriorityBlockingQueue &lt;Runnable &gt;( 20) ;</div><div class="line">      ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor (corePoolSize ,</div><div class="line">      maximumPoolSize , keepAliveTime, TimeUnit .MILLISECONDS , runnableTaskQueue );</div><div class="line">      logger. info( &quot;爬虫池启动&quot; );</div><div class="line">      for( Crawler crawler : crawlerList )&#123;</div><div class="line">           threadPoolExecutor .execute (crawler );</div><div class="line">      &#125;</div><div class="line">      //入库线程</div><div class="line">      logger. info( &quot;入库线程启动&quot; );</div><div class="line">      Thread t = new Thread (newsConsumer );</div><div class="line">      t. start() ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码解释：<br>1、由于无法预估每一个待抓取的网站结构和信息更新方式是不是一成不变的，因此，为每一个站点生成一个具体的实现类；<br>2、这里采用了生产者-消费者模式，由阻塞队列（BlockingQueue）来实现。每一个抓取线程都是生产者，消费者则只有一个入库线程；<br>工作流程如下：</p>
<ol>
<li>循环从初始化列表中获取待抓取类，实例化，并添加到抓取列表；</li>
<li>初始化线程池，由线程池来管理每一个抓取线程（一个线程对应一个站点抓取实例）；</li>
<li>启动入口线程；</li>
</ol>
<p>对于那些几乎都是同一类模式（列表+正文，排序方式按照更新时间倒序排列）的站点，可以抽象出一个抽象类实现共性的抓取逻辑，而每一个子类只实现一些细节点：<br>每一个Crawler都是一个线程，<br>下面介绍CommonNewsListSiteCrawler的实现逻辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">public void run() &#123;</div><div class="line">     try &#123;</div><div class="line">          crawl() ;</div><div class="line">     &#125; catch (Exception e ) &#123;</div><div class="line">          logger. error( &quot;crawl error&quot; , e) ;</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">protected void crawl()&#123;</div><div class="line">      boolean first = true ;</div><div class="line">      while( true )&#123;</div><div class="line">            try&#123;</div><div class="line">                 if( first)&#123;</div><div class="line">                      index = 30;</div><div class="line">                      first = false ;</div><div class="line">                 &#125; else&#123;</div><div class="line">                      index = 5;</div><div class="line">                 &#125;</div><div class="line">                 level = 0;</div><div class="line">                 duplicateNum = 0 ;</div><div class="line">                 NewsResult &lt;List &lt;PublishNewsModuleParams &gt;&gt; newsRes = NewsResult . getSuccessInstance() ;</div><div class="line">                 newsRes. setNextUrl( String .format (crawlUrl ,index ));</div><div class="line">                 do&#123;</div><div class="line">                      newsRes = parseHtml( newsRes. getNextUrl()) ;</div><div class="line">                      if( newsRes. isSuccess())&#123;</div><div class="line">                            int num = addToNewsQueue (newsRes );</div><div class="line">                            Jedis jedis = null;</div><div class="line">                            try&#123;</div><div class="line">                                 jedis = jedisPool. getResource ();</div><div class="line">                                 jedis. incrBy( RedisConstant .CRAWLER_NAMESPACE + namespace + &quot;crawlTotalNum&quot; , num) ;</div><div class="line">                                 jedis. incrBy( RedisConstant .CRAWLER_NAMESPACE + namespace + &quot;todayCrawlTotalNum&quot; , num) ;</div><div class="line">                                 jedis. set( RedisConstant .CRAWLER_NAMESPACE + namespace + &quot;currentCrawlUrl&quot; , currentCrawlUrl) ;</div><div class="line">                            &#125; catch( Exception e)&#123;</div><div class="line">                                 logger. error( &quot;Jedis error&quot; , e) ;</div><div class="line">                            &#125; finally&#123;</div><div class="line">                                 jedisPool. returnResource (jedis );</div><div class="line">                            &#125;</div><div class="line">                      &#125;</div><div class="line">                      else &#123;</div><div class="line">                            logger. error( &quot;解析抓取的url页面失败 ：&quot; + newsRes. getMessage()) ;</div><div class="line">                      &#125;</div><div class="line">                      generateNextUrl (newsRes );</div><div class="line">                 &#125; while( !newsRes .isEndCrawlFlag () &amp;&amp; index &gt; 0) ;</div><div class="line">//                   &#125;while(!newsRes.isEndCrawlFlag());</div><div class="line">            &#125; catch( Exception e)&#123;</div><div class="line">                 logger. error( &quot;failed!&quot; ,e );</div><div class="line">                 intervalTime = 60 *60 *1000 ;</div><div class="line">                 Jedis jedis = null;</div><div class="line">                 try&#123;</div><div class="line">                      jedis = jedisPool. getResource ();</div><div class="line">                      jedis. set( RedisConstant .CRAWLER_NAMESPACE + namespace + &quot;state&quot; , String .valueOf (2 ));</div><div class="line">                 &#125; catch( Exception e1)&#123;</div><div class="line">                      logger. error( &quot;Jedis error&quot; , e1) ;</div><div class="line">                 &#125; finally&#123;</div><div class="line">                      jedisPool. returnResource (jedis );</div><div class="line">                 &#125;</div><div class="line">            &#125;</div><div class="line">            try &#123;</div><div class="line">                 state = StateEnum .Sleeping ;</div><div class="line">                 Thread .sleep (intervalTime );</div><div class="line">            &#125; catch ( InterruptedException e) &#123;</div><div class="line">                 e. printStackTrace ();</div><div class="line">            &#125;</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码解释：<br>crawl方法是这一类爬虫的核心代码，每隔一段指定时间，它会抓取一次，考虑更新时间的问题，爬虫是从后往前抓取，即先抓取比较早的数据，首次抓取和第二次抓取设定不同的抓取深度即可（PS：采用这种简单粗暴的方式，能够满足我的实际需求，关注的是较新的内容，并且允许可能存在的丢失问题）<br>整个步骤如下：</p>
<ol>
<li>抓取当前列表页；</li>
<li>分析页面结构，用Jsoup解析出待抓取信息列表，循环处理列表每一条信息；<br>2.1、读取当前信息url地址，根据去重表判断是否已抓取过，如果没有，继续执行下一步；否则，处理下一条记录；<br>2.2、解析获取它的标题，并通过它的链接抓取正文信息，并解析其中的图片地址，调用图片服务器接口下载、存储该图片，并返回图片url；<pre><code>2.3、将解析到的内容包装成一个写入对象，加入阻塞队列中；
2.4、循环2.1 - 2.3，直到列表末尾； 
</code></pre></li>
<li>判断是否满足结束循环条件，是，则结束本次抓取过程，让线程进入睡眠状态；否则，生成下一条抓取记录；</li>
</ol>
<p>上述代码逻辑很简单，不过它能够满足当前的需求。同时，由于开销小，重复访问站点频次低，几乎不会被目标站点屏蔽（一直运行，目前尚未被任何一个站点屏蔽），并且能够保证更新内容在数分钟内同步抓取。结构简单使得代码维护起来非常轻松；</p>
<p>在实际应用中还会遇到一些小问题，也必须要妥善解决，例如：<br>1、如果某个站点的数据因为网站结构，程序bug等等导致数据失效，你要能够及时的修复；<br>2、由于目标站点可能会出现各种网络异常，结构更改等等，因此，需要一个实时监控页面，查看各个爬虫的实时数据是否正常（这里可以有很多优化的地方，不过由于太耗时间，现在只是把一些数据展现出来）；</p>
<p>总结：<br>在实际的项目中，初期，根据业务需要，尽可能考虑写一个满足当前业务需要的系统。不要追求各种高性能；<br>当然，我说的简单，以满足当前需求为前提，但是一些良好的工程习惯，如面向接口编程，设计类或者模块考虑“高内聚，低耦合”原则，以及代码的可扩展性，可读性等等都是需要你考虑的，这既是对项目负责，也可以让自己养成一个良好编程习惯。<br>用代码中的去重表实现来举例：<br>我在项目中将去重表作为一个类实现，因为去重表看似简单，但根据业务需求还是有很多不同的实现方式；如果你抓取的内容不多，那简单的一个hash表就满足你的要求了；为了避免程序重启或崩溃导致hash表数据丢失，你可能会用redis或其它nosql来实现；如果到后来你发现抓取的内容非常多，内存空间已经不够用了，可以更进一步，使用bloomfilter来实现，它可以大大减少内存开销，代价是存在小概率的误判，并且实现一个稳定可用的bloomfilter需要花费一定的时间成本；</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/05/18/从零开始打造一个新闻订阅APP之爬虫篇（一、背景介绍-需求分析）/" itemprop="url">
                  从零开始打造一个新闻订阅APP之爬虫篇（一、背景介绍&需求分析）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-05-18T21:31:11+08:00" content="2015-05-18">
              2015-05-18
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这段时间，打算好好写写博客，希望将自己前段时间的开发经历梳理一遍，看看能不能沉淀一些东西，也希望能够和有共同兴趣的同学一起探讨学习。<br>有兴趣的同学可以看看前两篇文章：<br><a href="http://xihuxiaolongren.com/2015/05/18/%E5%88%9B%E4%B8%9A%E6%A2%A6%E7%9A%84%E7%A0%B4%E7%A2%8E/">“创业梦”的破碎</a><br><a href="http://xihuxiaolongren.com/2015/05/18/%E5%B8%83%E6%9D%BF%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/">布板的前世今生</a><br>我开发的就是一个类似于Zaker和鲜果等新闻订阅服务的APP；接下来的一个系列，我都将是围绕这一个主题，按照一定的逻辑，介绍如何一步步地开发出一个新闻订阅APP。<br>首先，将会是第一部分：爬虫篇。<br>爬虫是我工作量最少，但是代码写的最有意思的一部分。<br>好了，言归正传，学习爬虫，不得不先提到通用搜索引擎的爬虫是如何工作的，先来看一张图：<br><img src="http://img.blog.csdn.net/20150518231917383" alt="这里写图片描述"><br>注：nutch原理图<br>这大概是网上流传最广的一张关于爬虫的介绍图，左半部分即是爬虫的工作流程了。<br>它的工作步骤简单的概括大致分为以下几步：</p>
<ol>
<li>指定需要搜索的页面集的url正则表达式;</li>
<li>注入urls种子，（通常是root url），并更新到待抓取集合中;</li>
<li>抓取当前待抓取集合中的urls所对应的页面;</li>
<li>解析抓取到的页面，包括： 提取超链接，去重，合并到待抓取集合中;</li>
<li>重复3,4两个步骤。直到集合为空或指定的抓取深度结束;</li>
</ol>
<p>通用搜索引擎能不能用于特定的爬虫呢？我的理解是肯定能，但是用已有的开源爬虫去解决自己的需求有以下两方面的问题：<br>1、“杀鸡焉用牛刀”，通用的爬虫搜索面临的问题是如何抓取一个体量巨大的信息网，解析各种各样不同的web文档结构，而我只是需要去抓取一类特定的站点；<br>2、“牛刀”用来“杀鸡”，必须要对它进行改造，但改造这把牛刀的成本太高。必须要对这把“刀”有非常深刻的理解，深入掌握它的工作原理，这样当爬虫遇到问题时，才能快速的通过修改内部代码去满足“杀鸡”的每一个细节，而理解它的过程耗费的时间和成本远远大于自己重新写一个简单，特定的爬虫系统；</p>
<p>基于上述两点考虑，我决定自己写一个简易的爬虫系统来满足自己抓取的需求。那么问题来了，<br>一、你要抓取哪些信息？以什么样的方式去存储和展现？<br>答：最初的想法就是抓取自己经常看的一些媒体，资讯类站点，先满足自己的需求。通过分析类似于“创业邦”、“36氪”、“Pingwest”等站点，可以发现它们的特点都是一样的：列表页面+正文信息。同样，抓取到移动端对应的也是一个个的站点-》信息列表-》正文内容；<br>二、目前系统主要解决的问题和瓶颈有哪些？<br>答： 1. 快速接入并稳定抓取当前业务需要的来源网站的news信息； 如何保证能够适应各种 html结构的页面解析；（合理的抽象+具体实现）；</p>
<ol>
<li>系统对单个站点的信息更新只需要最新的一部分内容； 不要对网站在短时间内产生大量抓取请求，容易被目标站点屏蔽； </li>
<li>系统稳定性保障代码的鲁棒性；爬虫可能面对的问题：解析失败， http返回各种的各种状态码处理 ,其它异常处理； </li>
<li>监控各个crawler的实时状态信息，对异常的信息进行人工处理； </li>
<li>在初期只能用一台机器简单，快速地完成所有的爬虫工作</li>
</ol>
<p>下一篇，我会详细介绍如何实现这样一个简单但满足当前需求的爬虫；</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="" />
          <p class="site-author-name" itemprop="name"></p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
